# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Purpose

This is a Terraform-based AWS homelab infrastructure project that provisions a secure, multi-tier network environment with jump box access, NAT instance, and private compute resources. The infrastructure is designed for learning cloud networking, security, and infrastructure-as-code best practices.

## Architecture Overview

The homelab implements a three-tier architecture:

1. **Public Subnet**: Contains jump box (bastion) and NAT instance with Elastic IPs
2. **Private Subnet**: Hosts main VM with no direct internet access, routes through NAT instance
3. **S3 Storage**: Private S3 bucket accessible only to main VM via VPC endpoint (no internet gateway required)

**Key Design Patterns:**
- Jump box pattern for secure SSH access to private resources
- NAT instance (not NAT Gateway) for cost optimization while learning network address translation
- Security group layering: jump box â†’ NAT instance/main VM
- Network ACLs on both public and private subnets for defense-in-depth
- IAM instance profiles with least-privilege policies
- VPC endpoint for S3 (private connectivity without traversing the internet)

## Terraform Commands

**Initialize Terraform:**
```bash
cd terraform
terraform init
```

**Plan infrastructure changes:**
```bash
terraform plan
```

**Apply infrastructure:**
```bash
terraform apply
```

**Destroy infrastructure:**
```bash
terraform destroy
```

**Format Terraform files:**
```bash
terraform fmt
```

**Validate configuration:**
```bash
terraform validate
```

**View current state:**
```bash
terraform show
```

**View outputs:**
```bash
terraform output
```

**Get SSH connection info:**
```bash
terraform output ssh_commands
```

## Required Variables

Must be provided in `terraform.tfvars` (gitignored):
- `profile`: AWS CLI profile name
- `region`: AWS region (e.g., "us-east-1")
- `ssh_key_name`: EC2 key pair name (note: Terraform auto-generates keys in `.ssh/` directory)

Optional variables (have defaults in variables.tf):
- `project_name`: Project prefix for resource naming (default: "homelab")
- `vpc_cidr`: VPC CIDR block (default: "10.0.0.0/16")
- `public_subnet_cidr`: Public subnet CIDR (default: "10.0.1.0/24")
- `private_subnet_cidr`: Private subnet CIDR (default: "10.0.2.0/24")
- `instance_types`: Map of instance types for jump_box, nat, and main_vm (default: all t3.micro)

## File Organization

Terraform configuration is split by resource category:

- **providers.tf**: Provider configuration (AWS, TLS, Local)
- **variables.tf**: Input variable definitions
- **data.tf**: Data sources (AMI lookup, availability zones, caller identity, external my_ip script)
- **network.tf**: VPC, subnets, Internet Gateway, route tables, routes
- **security.tf**: Security groups for all instances
- **nacls.tf**: Network ACL rules for public and private subnets
- **compute.tf**: EC2 instances (jump box, NAT instance, main VM), key pairs, EIPs
- **iam.tf**: IAM roles, instance profiles, and policies
- **s3.tf**: S3 bucket, versioning, encryption, public access block, bucket policy, VPC endpoint
- **outputs.tf**: Output values (IPs, bucket info, SSH commands)

**Supporting files:**
- **templates/userdata.tpl**: NAT instance user data script (enables IP forwarding, configures iptables)
- **scripts/my_ip_json.sh**: External data source to get current public IP for security group rules
- **.ssh/**: Auto-generated SSH keys (gitignored)

## SSH Access Pattern

1. **Connect to jump box:** `ssh -A -i terraform/.ssh/homelab-key.pem ec2-user@<jump_box_eip>`
2. **From jump box, connect to NAT instance:** `ssh ec2-user@<nat_private_ip>`
3. **From jump box, connect to main VM:** `ssh ec2-user@<main_vm_private_ip>`

SSH keys are automatically generated by Terraform using the TLS provider and stored in `terraform/.ssh/` (gitignored).

## NAT Instance Implementation

The NAT instance is manually configured (not AWS NAT Gateway) to demonstrate network fundamentals:

- User data script (templates/userdata.tpl) enables IP forwarding via sysctl
- iptables MASQUERADE rule translates private subnet traffic to NAT instance's public IP
- `source_dest_check = false` allows instance to forward traffic
- Private subnet route table points 0.0.0.0/0 to NAT instance's network interface

This approach is cost-effective for learning but not recommended for production (use NAT Gateway instead).

## Security Considerations

**Network Security:**
- Jump box accepts SSH only from your current public IP (dynamically retrieved)
- NAT instance accepts SSH only from jump box security group
- Main VM accepts SSH only from jump box security group
- Public NACL allows SSH only from your IP, plus ephemeral ports for return traffic
- Private NACL allows SSH only from public subnet, plus ephemeral ports

**IAM Security:**
- EC2 assume role policies for all instance profiles
- Jump box: CloudWatch Logs + SSM Session Manager access
- NAT instance: CloudWatch Logs access only
- Main VM: S3 bucket access (scoped to homelab bucket only) + CloudWatch Logs + SSM

**S3 Security:**
- Versioning enabled
- Server-side encryption (AES256)
- Public access blocked at bucket level
- Bucket policy restricts access to main VM role only
- VPC endpoint ensures S3 traffic stays within AWS network

**Secrets Management:**
- Never commit `terraform.tfvars`, `.ssh/` directory, or `*.pem` files
- `.gitignore` excludes state files, keys, and sensitive data

## Common Workflows

**Initial setup:**
```bash
cd terraform
# Create terraform.tfvars with required variables
terraform init
terraform plan
terraform apply
```

**SSH into main VM via jump box:**
```bash
# Terminal 1: Connect to jump box
ssh -i terraform/.ssh/homelab-key.pem ec2-user@$(terraform output -raw jump_box_public_ip)

# Terminal 1 (on jump box): Connect to main VM
ssh ec2-user@$(terraform output -raw main_vm_private_ip)
```

**Test S3 access from main VM:**
```bash
# On main VM
aws s3 ls s3://$(terraform output -raw s3_bucket_name)
echo "test" > test.txt
aws s3 cp test.txt s3://$(terraform output -raw s3_bucket_name)/
```

**Update security group rules:**
- Modify `security.tf` and apply changes
- For jump box SSH access, your IP is auto-detected; if it changes, re-run `terraform apply`

**Clean up:**
```bash
terraform destroy
```

## Important Notes

- The NAT instance configuration persists in user data but has `lifecycle.ignore_changes = [user_data]` to prevent unnecessary replacements
- State files contain sensitive data and are gitignored
- The external data source `my_ip_json.sh` runs on every `terraform plan/apply` to detect IP changes
- All resources are tagged with `${var.project_name}-*` naming convention for easy identification
- The main VM has no public IP and can only be accessed via the jump box
